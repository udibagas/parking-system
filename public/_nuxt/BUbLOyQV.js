import{E as be,a as ke}from"./BWIswVKu.js";import{l as ve,s as he,t as b,o as xe,E as we}from"./D2wCBoOa.js";import{E as Se,a as Te}from"./zJf7M3J2.js";import{a as Ae,b as Me}from"./BPhDp4Hz.js";import{E as Ke,u as je}from"./CCzsyj2c.js";import"./Cvzv-CJH.js";import{u as Ie}from"./CSy3DFL1.js";import{E as X}from"./Cwri-PQ-.js";import{u as Ee}from"./B7XaG9aP.js";import{o as fe,t as p,T as q,A as i,z as s,I as n,B as me,v as K,V as ee,W as te,U as H,_ as Ne,Q as Oe,r as W,c as $,a2 as Ce,x as l,y as F,G as O,a3 as ce,a0 as w,K as De,a4 as Le,$ as Q,Z as _e,a1 as Pe,C as qe,D as Be}from"./BvWa8xvQ.js";import{t as Z}from"./CbPeXI4l.js";import{s as Ue}from"./CVatRujo.js";import{h as S}from"./C5S46NFB.js";const Ye={__name:"FormBukaManual",props:["show","gateOutList"],emits:["close","open-gate"],setup(A,{emit:j}){const{show:D,gateOutList:u}=A,{api:e,formModel:g,formErrors:T}=Ee("/api/manualOpenLog"),h=j,B=()=>{g.value={},T.value={},h("close")},c=()=>{X.confirm("Aksi ini akan dicatat oleh sistem. Anda yakin?","Peringatan",{type:"warning"}).then(()=>e("/api/manualOpenLog",{method:"POST",body:g.value})).then(k=>{b({message:k.message,type:"success"}),h("open-gate",g.value.gate_out_id),B()}).catch(k=>{var _;((_=k.response)==null?void 0:_.status)==422&&(T.value=k.response._data.errors)})};return fe(()=>{u.length==1&&(g.value.gate_out_id=u[0].id)}),(k,_)=>{const v=xe,I=Se,U=Ae,ae=Me,ne=Te,R=we,G=Ke;return p(),q(G,{center:"",title:"FORM BUKA MANUAL","model-value":A.show,"before-close":B},{footer:i(()=>[s(R,{icon:n(ve),onClick:B},{default:i(()=>[me(" BATAL ")]),_:1},8,["icon"]),s(R,{icon:n(he),type:"primary",onClick:c},{default:i(()=>[me(" SIMPAN ")]),_:1},8,["icon"])]),default:i(()=>[s(ne,{"label-position":"left","label-width":"200px"},{default:i(()=>{var Y,J,V;return[s(I,{label:"Alasan buka manual",error:(Y=n(T).alasan)==null?void 0:Y.join(", ")},{default:i(()=>[s(v,{autofocus:"",type:"textarea",modelValue:n(g).alasan,"onUpdate:modelValue":_[0]||(_[0]=x=>n(g).alasan=x),rows:"3",placeholder:"Alasan buka manual"},null,8,["modelValue"])]),_:1},8,["error"]),A.gateOutList.length>1?(p(),q(I,{key:0,label:"Gate Keluar",error:(J=n(T).gate_out_id)==null?void 0:J.join(", ")},{default:i(()=>[s(ae,{modelValue:n(g).gate_out_id,"onUpdate:modelValue":_[1]||(_[1]=x=>n(g).gate_out_id=x),style:{width:"100%"},placeholder:"Gate Keluar"},{default:i(()=>[(p(!0),K(ee,null,te(A.gateOutList,x=>(p(),q(U,{key:x.id,label:x.nama,value:x.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["error"])):H("",!0),s(I,{label:"Masukkan password Admin",error:(V=n(T).password)==null?void 0:V.join(", ")},{default:i(()=>[s(v,{type:"password",modelValue:n(g).password,"onUpdate:modelValue":_[2]||(_[2]=x=>n(g).password=x),placeholder:"Password"},null,8,["modelValue"])]),_:1},8,["error"])]}),_:1})]),_:1},8,["model-value"])}}},C=A=>(qe("data-v-499a19e4"),A=A(),Be(),A),$e={key:0,class:"flex",id:"gate-out-app",style:{height:"calc(100vh - 100px)"},tabindex:"1"},Re={style:{width:"600px","flex-shrink":"0"}},Ve={class:"mt-0 mb-3 p-2 bg-red text-white text-center text-xl"},Fe=C(()=>l("div",{class:"label-big"},"[-] NO. PLAT",-1)),He=C(()=>l("div",{class:"label-big"},"[+] NO. TIKET/KARTU",-1)),Ge=C(()=>l("div",{class:"label-big"},"[*] JENIS KENDARAAN",-1)),Je=["value"],ze=C(()=>l("div",{class:"label-big"},"[*] JAM MASUK",-1)),We=C(()=>l("div",{class:"label-big"},"GATE MASUK",-1)),Qe=["value"],Ze=C(()=>l("div",{class:"label-big"},"TARIF",-1)),Xe=C(()=>l("div",{class:"label-big"},"TARIF + DENDA",-1)),et=["value"],tt=["src"],at={key:1,class:"flex flex-row justify-content-center align-items-center",style:{height:"calc(100vh - 145px)"}},nt=C(()=>l("div",{class:"text-center text-5xl text-danger"}," KOMPUTER INI TIDAK TERDAFTAR SEBAGAI POS ",-1)),ot=[nt],rt={__name:"index",setup(A){const j=je(),D=Ie(),u=Pe(),e=Oe({nomor_barcode:"",tarif:"",denda:""}),g=W([]),T=W(!1),h=W(null),B=W(null),c=$(()=>j.pos),k=$(()=>j.setting),_=$(()=>j.gateInList),v=$(()=>j.jenisKendaraanList),I=$(()=>{if(!e.time_in||!e.time_out)return"00:00:00";let a=S(e.time_in),t=S(e.time_out),r=t.diff(a,"days"),d=t.diff(a,"hours"),f=t.diff(a,"minutes");return`${r}HR ${String(d%24).padStart(2,"0")}:${String(f%60).padStart(2,"0")}`}),U=$(()=>Number(e.tarif)+Number(e.denda)),ae=()=>{z(`${I}|${Z(U)}`),document.querySelector("#submit-btn").focus()},ne=()=>{_.value.length==1&&(e.gate_in_id=_.value[0].id),e.gate_in_id?document.querySelector("#submit-btn").focus():document.querySelector("#gate-in").focus(),z(`${I}|${Z(U)}`)},R=()=>{document.querySelector("#submit-btn1").focus()},G=()=>{document.querySelector("#submit-btn").focus()},Y=()=>{e.group=v.value.find(m=>m.nama==e.jenis_kendaraan).group;const a=c.value.gate_outs.find(m=>m.jenis_kendaraan.includes(e.jenis_kendaraan));if(!a){b({message:"Tidak ada gate keluar untuk jenis kendaraan terkait",type:"error"});return}if(e.gate_out_id=a.id,e.id&&de(),e.is_member){e.tarif=0,document.querySelector("#submit-btn").focus();return}const t=v.value.find(m=>m.nama==e.jenis_kendaraan);if(!t){b({message:"Tarif tidak ditemukan untuk jenis kendaraan "+e.jenis_kendaraan,type:"error",showClose:!0}),e.tarif=0;return}e.nomor_barcode.toLowerCase()=="xxxxx"?e.denda=Number(t.denda_tiket_hilang):e.denda=0;let r=S(e.time_in),d=e.time_out?S(e.time_out):S(),f=d.diff(r,"minutes")||1,E=t.tarif_menit_pertama;if(f<=t.menit_pertama){e.tarif=E,document.querySelector("#submit-btn").focus(),z(`${I}|${Z(U)}`);return}let o=f-t.menit_pertama,y;if(t.mode_menginap==0&&(y=Math.ceil(f/(60*24)),y==0&&t.mode_tarif==0&&(y=1)),t.mode_menginap==1){let m=S(r.format("YYYY-MM-DD")),N=S(d.format("YYYY-MM-DD"));y=0,f>=60?y=N.diff(m,"days")+1:y=1}let M=y>=1?y-1:0,L=M*t.tarif_menginap;if(t.mode_tarif==0&&(e.tarif=E+y*t.tarif_flat+L),t.mode_tarif==1){let m=M*t.tarif_maksimum;if(t.mode_menginap==0){const N=f%1440;let P=0;N<=t.menit_pertama?P=t.tarif_menit_pertama:P=t.tarif_menit_pertama+Math.ceil((N-t.menit_pertama)/t.menit_selanjutnya)*t.tarif_menit_selanjutnya,P>t.tarif_maksimum&&(P=t.tarif_maksimum),e.tarif=m+P+L}if(t.mode_menginap==1)if(y>1){let N=S(r.format("YYYY-MM-DD")+" 24:00:00").diff(r,"minutes")-t.menit_pertama,P=d.diff(S(d.format("YYYY-MM-DD")+" 00:00:00"),"minutes"),ie=Math.ceil(N/t.menit_selanjutnya)*t.tarif_menit_selanjutnya;tarifHariTerakhir=Math.ceil(P/t.menit_selanjutnya)*t.tarif_menit_selanjutnya,ie>t.tarif_maksimum&&(ie=t.tarif_maksimum),tarifHariTerakhir>t.tarif_maksimum&&(tarifHariTerakhir=t.tarif_maksimum),y<=2&&(m=0),e.tarif=E+m+ie+tarifHariTerakhir+L}else tarifHariPertama=Math.ceil(o/t.menit_selanjutnya)*t.tarif_menit_selanjutnya,tarifHariPertama>t.tarif_maksimum&&(tarifHariPertama=t.tarif_maksimum),e.tarif=E+tarifHariPertama}e.nomor_barcode.toLowerCase()=="xxxxx"?document.querySelector("#time-in").focus():document.querySelector("#submit-btn").focus(),z(`${I}|${Z(U)}`)},J=()=>{let a={plat_nomor:e.plat_nomor};D("/api/member/search",{method:"get",query:a}).then(t=>{e.is_member=1,e.tarif=0}).catch(t=>{e.is_member=0}).finally(()=>{var t;document.querySelector("#nomor-tiket").focus(),(t=u==null?void 0:u.proxy)==null||t.$forceUpdate()})},V=async()=>{var t,r,d;if(e.nomor_barcode.length<5)return;let a=S().format("YYYY-MM-DD HH:mm:ss");if(e.nomor_barcode.toLowerCase()=="xxxxx"){e.time_in=S().format("YYYY-MM-DD"),(t=u==null?void 0:u.proxy)==null||t.$forceUpdate(),e.time_out=a,v.value.length>1?document.querySelector("#jenis-kendaraan").focus():(e.jenis_kendaraan=v.value[0].nama,document.querySelector("#time-in").focus());return}try{let f=await D("/api/parkingTransaction/search",{query:{nomor_barcode:e.nomor_barcode}});g.value=f.snapshots;const{id:E,gate_in_id:o,is_member:y,member:M}=f;if(e.id=E,e.gate_in_id=o,e.is_member=y,e.time_out=a,e.tarif=0,(r=u==null?void 0:u.proxy)==null||r.$forceUpdate(),!y&&v.value.length>1){document.querySelector("#jenis-kendaraan").focus();return}if(y){if(M.expired)return X.alert("Kartu telah habis masa berlaku","Perhatian",{type:"warning",center:!0,roundButton:!0,confirmButtonText:"OK",confirmButtonClass:"bg-red"}),e.is_member=0,!1;if(!M.expired&&M.expired_in<=5&&X.alert(`Kartu akan habis masa berlaku dalam ${M.expired_in} hari`,"Perhatian",{type:"warning",center:!0,roundButton:!0,confirmButtonText:"OK",confirmButtonClass:"bg-red"}),k.value.disable_plat_nomor){document.querySelector("#submit-btn").focus();const L=f.member.vehicles[0];e.jenis_kendaraan=L.jenis_kendaraan,e.plat_nomor=L.plat_nomor;const m=c.value.gate_outs.find(N=>N.jenis_kendaraan.includes(e.jenis_kendaraan));if(!m){b({message:"Tidak ada gate keluar untuk jenis kendaraan terkait",type:"error"});return}e.gate_out_id=m.id,k.value.member_auto_open&&(e.id&&de(),le(!1))}else M.vehicles.find(m=>m.plat_nomor==e.plat_nomor)?v.value.length>1&&document.querySelector("#jenis-kendaraan").focus():(X.alert("Plat nomor tidak cocok dengan kartu. Nomor plat yang terdaftar adalah "+M.vehicles.map(m=>m.plat_nomor).join(", "),"Perhatian",{type:"warning",center:!0,roundButton:!0,confirmButtonText:"OK",confirmButtonClass:"bg-red"}),document.querySelector("#plat-nomor").focus())}v.value.length==1&&(e.jenis_kendaraan=v.value[0].nama,Y())}catch(f){((d=f.response)==null?void 0:d.status)==404&&b({message:f.response._data.message,type:"error",center:!0,showClose:!0,duration:3e3}),document.querySelector("#nomor-tiket").focus()}},x=()=>{var a;ge(),e.tarif="",e.denda="",e.gate_in_id=null,e.gate_out_id=null,e.jenis_kendaraan=null,e.plat_nomor=k.value.plat_nomor_default,e.nomor_barcode="",e.time_out="",e.time_in=void 0,e.duration="",g.value=[],(a=u==null?void 0:u.proxy)==null||a.$forceUpdate(),k.value.disable_plat_nomor?(console.log("ke nomor tiket"),document.querySelector("#nomor-tiket").focus()):(console.log("ke plat nomor"),document.querySelector("#plat-nomor").focus())},se=a=>{var t;if(console.log(e),e.nomor_barcode.toLowerCase()=="xxxxx"&&!e.time_in){document.querySelector("#time-in").focus();return}else document.querySelector("#submit-btn").blur();if(_.value.length==1&&(e.gate_in_id=_.value[0].id),!e.gate_in_id){b({message:"MOHON ISI GATE IN",type:"error",showClose:!0});return}if(!(!e.nomor_barcode||!e.gate_out_id||!e.jenis_kendaraan||!e.time_out)){if(((t=e.time_in)==null?void 0:t.length)<16){b({message:"FORMAT TIME IN SALAH",type:"error",showClose:!0});return}le(a)}},le=async a=>{e.ticket=a;const t=e.id?`/api/parkingTransaction/${e.id}`:"/api/parkingTransaction";try{const r=await D(t,{method:e.id?"put":"post",body:e});b({message:r.message,type:"success"});const d=e.gate_out_id;ue(d)}catch(r){b({message:r.response._data.message,type:"error",showClose:!0})}},pe=()=>{h.value=new WebSocket(`ws://${c.value.ip_address}:5678/`),h.value.onerror=a=>{b({message:"KONEKSI KE POS GAGAL",type:"error"})},h.value.onopen=a=>{console.log("POS TEKONEKSI")},h.value.onmessage=a=>{let t=JSON.parse(a.data);console.error(t)}},ue=a=>{const t=c.value.gate_outs.find(r=>r.id==a);h.value.send(["open",t.device,t.baudrate,t.open_command,t.close_command].join(";")),setTimeout(x,1e3)},z=a=>{const t=c.value.gate_outs.find(r=>r.id==e.gate_out_id);t&&(!t.running_text_device||!t.running_text_baudrate||h.value.send(["rt",t.running_text_device,t.running_text_baudrate,a].join(";")))},ge=()=>{const a=c.value.gate_outs.find(t=>t.id==e.gate_out_id);a&&(!a.running_text_device||!a.running_text_baudrate||h.value.send(["rrt",a.running_text_device,a.running_text_baudrate].join(";")))},oe=async()=>{try{const a=await D("/api/parkingTransaction/printLastTransaction",{method:"post",body:{pos_id:e.pos_id}});b({message:a.message,type:"success",showClose:!0})}catch(a){b({message:a.response._data.message,type:"error",showClose:!0})}},re=async()=>{let a={pos_id:e.pos_id,date:S().format("YYYY-MM-DD")};try{await D("/api/parkingTransaction/printReport",{method:"post",body:a}),b({message:"SILAKAN AMBIL STRUK",type:"success",showClose:!0})}catch(t){b({message:t.response._data.message,type:"error",showClose:!0})}},ye=async()=>{await j.getPos(),c.value&&(e.pos_id=c.value.id,c.value.gate_outs.length==1&&(e.gate_out_id=c.value.gate_outs[0].id),e.plat_nomor=k.value.plat_nomor_default,k.value.disable_plat_nomor?document.querySelector("#nomor-tiket").focus():document.querySelector("#plat-nomor").focus(),pe())},de=async()=>{var a;try{const t=await D(`/api/parkingTransaction/takeSnapshot/${e.id}`,{method:"post",body:{gate_out_id:e.gate_out_id}});g.value=t,(a=u==null?void 0:u.proxy)==null||a.$forceUpdate()}catch(t){b({message:t.response._data.message,type:"error",showClose:!0})}};return fe(async()=>{await ye(),c.value&&(document.getElementById("gate-out-app").addEventListener("keydown",a=>{var t;a.key=="-"&&(a.preventDefault(),x(),(t=u==null?void 0:u.proxy)==null||t.$forceUpdate()),a.key=="+"&&(a.preventDefault(),e.nomor_barcode="",e.time_out="",e.jenis_kendaraan="",e.tarif="",document.querySelector("#nomor-tiket").focus()),a.key=="*"&&(a.preventDefault(),e.jenis_kendaraan="",e.tarif="",document.querySelector("#jenis-kendaraan").focus()),a.key=="/"&&(a.preventDefault(),e.time_in="",document.querySelector("#time-in").focus()),a.key=="F10"&&(a.preventDefault(),re()),a.key=="F11"&&(a.preventDefault(),T.value=!0),a.key=="F12"&&(a.preventDefault(),oe())}),B.value=Ue(j.getJenisKendaraanList,6e4))}),Ce(()=>{h.value&&h.value.close(),clearInterval(B.value)}),(a,t)=>{const r=ke,d=be,f=Ye,E=Le("mask");return n(c)?(p(),K("div",$e,[l("div",Re,[l("h1",Ve,F(n(c).nama),1),n(k).disable_plat_nomor?H("",!0):(p(),q(d,{key:0,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Fe]),_:1}),s(r,{span:14},{default:i(()=>[O(l("input",{id:"plat-nomor",autocomplete:"off",onKeyup:w(J,["enter"]),type:"text",placeholder:"NO. PLAT","onUpdate:modelValue":t[0]||(t[0]=o=>n(e).plat_nomor=o),class:"my-input"},null,544),[[Q,n(e).plat_nomor]])]),_:1})]),_:1})),s(d,{gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[He]),_:1}),s(r,{span:14},{default:i(()=>[O(l("input",{id:"nomor-tiket",autocomplete:"off",onKeyup:w(V,["enter"]),onKeydown:w(V,["tab"]),type:"text",placeholder:"NO. TIKET/KARTU","onUpdate:modelValue":t[1]||(t[1]=o=>n(e).nomor_barcode=o),class:"my-input"},null,544),[[Q,n(e).nomor_barcode]])]),_:1})]),_:1}),n(v).length>1?(p(),q(d,{key:1,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Ge]),_:1}),s(r,{span:14},{default:i(()=>[O(l("select",{onChange:Y,"onUpdate:modelValue":t[2]||(t[2]=o=>n(e).jenis_kendaraan=o),id:"jenis-kendaraan",class:"my-input",placeholder:"JENIS KENDARAAN"},[(p(!0),K(ee,null,te(n(v),o=>(p(),K("option",{value:o.nama,key:o.id},F(o.shortcut_key)+" - "+F(o.nama),9,Je))),128))],544),[[_e,n(e).jenis_kendaraan]])]),_:1})]),_:1})):H("",!0),O(s(d,{gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[ze]),_:1}),s(r,{span:14},{default:i(()=>[O(l("input",{onKeyup:w(ne,["enter"]),onChange:Y,id:"time-in","onUpdate:modelValue":t[3]||(t[3]=o=>n(e).time_in=o),class:"my-input"},null,544),[[E,"####-##-## ##:##"],[Q,n(e).time_in]])]),_:1})]),_:1},512),[[ce,n(e).nomor_barcode=="xxxxx"]]),n(_).length>1?O((p(),q(d,{key:2,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[We]),_:1}),s(r,{span:14},{default:i(()=>[O(l("select",{onChange:ae,"onUpdate:modelValue":t[4]||(t[4]=o=>n(e).gate_in_id=o),id:"gate-in",class:"my-input"},[(p(!0),K(ee,null,te(n(_),o=>(p(),K("option",{value:o.id,key:o.id},F(o.shortcut_key)+" - "+F(o.nama),9,Qe))),128))],544),[[_e,n(e).gate_in_id]])]),_:1})]),_:1},512)),[[ce,n(e).nomor_barcode=="xxxxx"]]):H("",!0),s(d,{gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Ze]),_:1}),s(r,{span:14},{default:i(()=>[O(l("input",{disabled:"","onUpdate:modelValue":t[5]||(t[5]=o=>n(e).tarif=o),class:"my-input bg-red-700 text-white"},null,512),[[Q,n(e).tarif]])]),_:1})]),_:1}),n(e).nomor_barcode=="xxxxx"?(p(),q(d,{key:3,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Xe]),_:1}),s(r,{span:14},{default:i(()=>[l("input",{disabled:"",value:Number(n(e).tarif)+Number(n(e).denda),class:"my-input bg-red-700 text-white"},null,8,et)]),_:1})]),_:1})):H("",!0),l("button",{id:"submit-btn",onKeyup:[w(R,["right"]),w(R,["down"])],onKeydown:t[6]||(t[6]=w(o=>se(!1),["enter"])),class:"my-big-btn",onClick:t[7]||(t[7]=o=>se(!1))}," BUKA GATE ",32),l("button",{id:"submit-btn1",onKeyup:[w(G,["left"]),w(G,["up"])],onKeydown:w(oe,["enter"]),class:"my-big-btn",onClick:oe}," [F12] PRINT STRUK TRANSAKSI TERAKHIR ",32),s(d,{gutter:10},{default:i(()=>[s(r,{span:12},{default:i(()=>[l("button",{onKeydown:w(re,["enter"]),class:"my-big-btn",onClick:re}," [F10] PRINT LAPORAN ",32)]),_:1}),s(r,{span:12},{default:i(()=>[l("button",{class:"my-big-btn",onKeydown:t[8]||(t[8]=w(o=>T.value=!0,["enter"])),onClick:t[9]||(t[9]=o=>T.value=!0)}," [F11] BUKA GATE MANUAL ",32)]),_:1})]),_:1})]),l("div",{class:De({"ml-5":!0,flex:n(k).orientasi_kamera=="POTRAIT"}),style:{width:"100%"}},[(p(!0),K(ee,null,te(n(g),o=>(p(),K("div",{class:"mb-1",style:{width:"100%"},key:o.id},[l("img",{src:o.url,style:{width:"700px"}},null,8,tt)]))),128))],2),s(f,{show:n(T),onClose:t[10]||(t[10]=o=>T.value=!1),gateOutList:n(c).gate_outs,onOpenGate:t[11]||(t[11]=o=>ue(o))},null,8,["show","gateOutList"])])):(p(),K("div",at,ot))}}},kt=Ne(rt,[["__scopeId","data-v-499a19e4"]]);export{kt as default};
