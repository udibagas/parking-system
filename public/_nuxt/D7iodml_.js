import{E as be,a as ke}from"./BvKf6nDs.js";import{l as ve,s as he,t as p,o as xe,E as we}from"./DqHsojZP.js";import{E as Se,a as Te}from"./BQLTMqPt.js";import{u as _e,a as Ae,b as Me}from"./FMEpvrbw.js";import{E as Ke,u as je}from"./QmKkmSH8.js";import"./PCoquCIv.js";import{E as Ee}from"./BvEecX3s.js";import{o as fe,t as f,T as L,A as i,z as s,I as n,B as de,v as M,V as X,W as ee,U as F,_ as Ie,Q as Ne,r as Q,c as q,a2 as Oe,x as u,y as V,G as I,a3 as me,a0 as v,K as Ce,a4 as De,$ as Z,Z as ce,a1 as Le,C as Pe,D as Be}from"./C96A3IUC.js";import{s as Ue}from"./8u2_rn-p.js";import{h}from"./C5S46NFB.js";const Ye={__name:"FormBukaManual",props:["show","gateOutList"],emits:["close","open-gate"],setup(T,{emit:K}){const{show:O,gateOutList:C}=T,{api:d,formModel:e,formErrors:w}=_e("/api/manualOpenLog"),j=K,y=()=>{e.value={},w.value={},j("close")},H=()=>{Ee.confirm("Aksi ini akan dicatat oleh sistem. Anda yakin?","Peringatan",{type:"warning"}).then(()=>d("/api/manualOpenLog",{method:"POST",body:e.value})).then(m=>{p({message:m.message,type:"success"}),j("open-gate",e.value.gate_out_id),y()}).catch(m=>{var c;((c=m.response)==null?void 0:c.status)==422&&(w.value=m.response._data.errors)})};return fe(()=>{C.length==1&&(e.value.gate_out_id=C[0].id)}),(m,c)=>{const A=xe,g=Se,P=Ae,B=Me,te=Te,G=we,J=Ke;return f(),L(J,{center:"",title:"FORM BUKA MANUAL","model-value":T.show,"before-close":y},{footer:i(()=>[s(G,{icon:n(ve),onClick:y},{default:i(()=>[de(" BATAL ")]),_:1},8,["icon"]),s(G,{icon:n(he),type:"primary",onClick:H},{default:i(()=>[de(" SIMPAN ")]),_:1},8,["icon"])]),default:i(()=>[s(te,{"label-position":"left","label-width":"200px"},{default:i(()=>{var R,U,z;return[s(g,{label:"Alasan buka manual",error:(R=n(w).alasan)==null?void 0:R.join(", ")},{default:i(()=>[s(A,{autofocus:"",type:"textarea",modelValue:n(e).alasan,"onUpdate:modelValue":c[0]||(c[0]=k=>n(e).alasan=k),rows:"3",placeholder:"Alasan buka manual"},null,8,["modelValue"])]),_:1},8,["error"]),T.gateOutList.length>1?(f(),L(g,{key:0,label:"Gate Keluar",error:(U=n(w).gate_out_id)==null?void 0:U.join(", ")},{default:i(()=>[s(B,{modelValue:n(e).gate_out_id,"onUpdate:modelValue":c[1]||(c[1]=k=>n(e).gate_out_id=k),style:{width:"100%"},placeholder:"Gate Keluar"},{default:i(()=>[(f(!0),M(X,null,ee(T.gateOutList,k=>(f(),L(P,{key:k.id,label:k.nama,value:k.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["error"])):F("",!0),s(g,{label:"Masukkan password Admin",error:(z=n(w).password)==null?void 0:z.join(", ")},{default:i(()=>[s(A,{type:"password",modelValue:n(e).password,"onUpdate:modelValue":c[2]||(c[2]=k=>n(e).password=k),placeholder:"Password"},null,8,["modelValue"])]),_:1},8,["error"])]}),_:1})]),_:1},8,["model-value"])}}},N=T=>(Pe("data-v-6aade1cc"),T=T(),Be(),T),$e={key:0,class:"flex",id:"gate-out-app",style:{height:"calc(100vh - 100px)"},tabindex:"1"},qe={style:{width:"600px","flex-shrink":"0"}},Re={class:"mt-0 mb-3 p-2 bg-red text-white text-center text-xl"},Ve=N(()=>u("div",{class:"label-big"},"[-] NO. PLAT",-1)),Fe=N(()=>u("div",{class:"label-big"},"[+] NO. TIKET/KARTU",-1)),He=N(()=>u("div",{class:"label-big"},"[*] JENIS KENDARAAN",-1)),Ge=["value"],Je=N(()=>u("div",{class:"label-big"},"[*] JAM MASUK",-1)),ze=N(()=>u("div",{class:"label-big"},"GATE MASUK",-1)),We=["value"],Qe=N(()=>u("div",{class:"label-big"},"TARIF",-1)),Ze=N(()=>u("div",{class:"label-big"},"TARIF + DENDA",-1)),Xe=["value"],et=["src"],tt={key:1,class:"flex flex-row justify-content-center align-items-center",style:{height:"calc(100vh - 145px)"}},at=N(()=>u("div",{class:"text-center text-5xl text-danger"}," KOMPUTER INI TIDAK TERDAFTAR SEBAGAI POS ",-1)),nt=[at],ot={__name:"index",setup(T){const K=je(),{api:O,toRupiah:C}=_e(),d=Le(),e=Ne({nomor_barcode:"",tarif:"",denda:""}),w=Q([]),j=Q(!1),y=Q(null),H=Q(null),m=q(()=>K.pos),c=q(()=>K.setting),A=q(()=>K.gateInList),g=q(()=>K.jenisKendaraanList),P=q(()=>{if(!e.time_in||!e.time_out)return"00:00:00";let a=h(e.time_in),t=h(e.time_out),r=t.diff(a,"days"),l=t.diff(a,"hours"),x=t.diff(a,"minutes");return`${r}HR ${String(l%24).padStart(2,"0")}:${String(x%60).padStart(2,"0")}`}),B=q(()=>Number(e.tarif)+Number(e.denda)),te=()=>{W(`${P}|${C(B)}`),document.querySelector("#submit-btn").focus()},G=()=>{A.value.length==1&&(e.gate_in_id=A.value[0].id),e.gate_in_id?document.querySelector("#submit-btn").focus():document.querySelector("#gate-in").focus(),W(`${P}|${C(B)}`)},J=()=>{document.querySelector("#submit-btn1").focus()},R=()=>{document.querySelector("#submit-btn").focus()},U=()=>{e.group=g.value.find(b=>b.nama==e.jenis_kendaraan).group;const a=m.value.gate_outs.find(b=>b.jenis_kendaraan.includes(e.jenis_kendaraan));if(!a){p({message:"Tidak ada gate keluar untuk jenis kendaraan terkait",type:"error"});return}if(e.gate_out_id=a.id,e.id&&ue(),e.is_member){e.tarif=0,document.querySelector("#submit-btn").focus();return}const t=g.value.find(b=>b.nama==e.jenis_kendaraan);if(!t){p({message:"Tarif tidak ditemukan untuk jenis kendaraan "+e.jenis_kendaraan,type:"error",showClose:!0}),e.tarif=0;return}e.nomor_barcode.toLowerCase()=="xxxxx"?e.denda=Number(t.denda_tiket_hilang):e.denda=0;let r=h(e.time_in),l=e.time_out?h(e.time_out):h(),x=l.diff(r,"minutes")||1,E=t.tarif_menit_pertama;if(x<=t.menit_pertama){e.tarif=E,document.querySelector("#submit-btn").focus(),W(`${P}|${C(B)}`);return}let o=x-t.menit_pertama,_;if(t.mode_menginap==0&&(_=Math.ceil(x/(60*24)),_==0&&t.mode_tarif==0&&(_=1)),t.mode_menginap==1){let b=h(r.format("YYYY-MM-DD")),$=h(l.format("YYYY-MM-DD"));_=0,x>=60?_=$.diff(b,"days")+1:_=1}let Y=_>=1?_-1:0,S=Y*t.tarif_menginap;if(t.mode_tarif==0&&(e.tarif=E+_*t.tarif_flat+S),t.mode_tarif==1){let b=Y*t.tarif_maksimum;if(t.mode_menginap==0){const $=x%1440;let D=0;$<=t.menit_pertama?D=t.tarif_menit_pertama:D=t.tarif_menit_pertama+Math.ceil(($-t.menit_pertama)/t.menit_selanjutnya)*t.tarif_menit_selanjutnya,D>t.tarif_maksimum&&(D=t.tarif_maksimum),e.tarif=b+D+S}if(t.mode_menginap==1)if(_>1){let $=h(r.format("YYYY-MM-DD")+" 24:00:00").diff(r,"minutes")-t.menit_pertama,D=l.diff(h(l.format("YYYY-MM-DD")+" 00:00:00"),"minutes"),oe=Math.ceil($/t.menit_selanjutnya)*t.tarif_menit_selanjutnya;tarifHariTerakhir=Math.ceil(D/t.menit_selanjutnya)*t.tarif_menit_selanjutnya,oe>t.tarif_maksimum&&(oe=t.tarif_maksimum),tarifHariTerakhir>t.tarif_maksimum&&(tarifHariTerakhir=t.tarif_maksimum),_<=2&&(b=0),e.tarif=E+b+oe+tarifHariTerakhir+S}else tarifHariPertama=Math.ceil(o/t.menit_selanjutnya)*t.tarif_menit_selanjutnya,tarifHariPertama>t.tarif_maksimum&&(tarifHariPertama=t.tarif_maksimum),e.tarif=E+tarifHariPertama}e.nomor_barcode.toLowerCase()=="xxxxx"?document.querySelector("#time-in").focus():document.querySelector("#submit-btn").focus(),W(`${P}|${C(B)}`)},z=()=>{let a={plat_nomor:e.plat_nomor};O("/api/member/search",{method:"get",query:a}).then(t=>{e.is_member=1,e.tarif=0}).catch(t=>{e.is_member=0}).finally(()=>{var t;document.querySelector("#nomor-tiket").focus(),(t=d==null?void 0:d.proxy)==null||t.$forceUpdate()})},k=async()=>{var t,r;if(e.nomor_barcode.length<5)return;let a=h().format("YYYY-MM-DD HH:mm:ss");if(e.nomor_barcode.toLowerCase()=="xxxxx"){e.time_in=h().format("YYYY-MM-DD"),(t=d==null?void 0:d.proxy)==null||t.$forceUpdate(),e.time_out=a,g.value.length>1?document.querySelector("#jenis-kendaraan").focus():(e.jenis_kendaraan=g.value[0].nama,document.querySelector("#time-in").focus());return}try{let l=await O("/api/parkingTransaction/search",{query:{nomor_barcode:e.nomor_barcode}});w.value=l.snapshots;const{id:x,gate_in_id:E,is_member:o,member:_}=l;if(e.id=x,e.gate_in_id=E,e.is_member=o,e.time_out=a,e.tarif=0,(r=d==null?void 0:d.proxy)==null||r.$forceUpdate(),!o&&g.value.length>1){document.querySelector("#jenis-kendaraan").focus();return}if(o){if(_.expired)return ElAlert("Kartu telah habis masa berlaku","Perhatian",{type:"warning",center:!0,roundButton:!0,confirmButtonText:"OK",confirmButtonClass:"bg-red"}),e.is_member=0,!1;if(!_.expired&&_.expired_in<=5&&ElAlert(`Kartu akan habis masa berlaku dalam ${_.expired_in} hari`,"Perhatian",{type:"warning",center:!0,roundButton:!0,confirmButtonText:"OK",confirmButtonClass:"bg-red"}),c.value.disable_plat_nomor){const Y=l.member.vehicles[0];if(e.jenis_kendaraan=Y.jenis_kendaraan,e.plat_nomor=Y.plat_nomor,c.value.member_auto_open){const S=m.gate_outs.find(b=>b.jenis_kendaraan.includes(e.jenis_kendaraan));if(!S){p({message:"Tidak ada gate keluar untuk jenis kendaraan terkait",type:"error"});return}e.gate_out_id=S.id,e.id&&ue(),se(!1)}}else _.vehicles.find(S=>S.plat_nomor==e.plat_nomor)?g.value.length>1&&document.querySelector("#jenis-kendaraan").focus():(ElAlert("Plat nomor tidak cocok dengan kartu. Nomor plat yang terdaftar adalah "+_.vehicles.map(S=>S.plat_nomor).join(", "),"Perhatian",{type:"warning",center:!0,roundButton:!0,confirmButtonText:"OK",confirmButtonClass:"bg-red"}),document.querySelector("#plat-nomor").focus())}g.value.length==1&&(e.jenis_kendaraan=g.value[0].nama,U())}catch(l){console.log(l),l.response.status==404&&p({message:l.response.data.message,type:"error",center:!0,showClose:!0,duration:3e3}),document.querySelector("#nomor-tiket").focus()}},re=()=>{var a;ge(),e.tarif="",e.denda="",e.gate_in_id=null,e.gate_out_id=null,e.jenis_kendaraan=null,e.plat_nomor=c.value.plat_nomor_default,e.nomor_barcode="",e.time_out="",e.time_in=void 0,e.duration="",w.value=[],(a=d==null?void 0:d.proxy)==null||a.$forceUpdate(),c.value.disable_plat_nomor?(console.log("ke nomor tiket"),document.querySelector("#nomor-tiket").focus()):(console.log("ke plat nomor"),document.querySelector("#plat-nomor").focus())},ie=a=>{var t;if(e.nomor_barcode.toLowerCase()=="xxxxx"&&!e.time_in){document.querySelector("#time-in").focus();return}else document.querySelector("#submit-btn").blur();if(A.value.length==1&&(e.gate_in_id=A.value[0].id),!e.gate_in_id){p({message:"MOHON ISI GATE IN",type:"error",showClose:!0});return}if(!(!e.nomor_barcode||!e.gate_out_id||!e.jenis_kendaraan||!e.time_out)){if(((t=e.time_in)==null?void 0:t.length)<16){p({message:"FORMAT TIME IN SALAH",type:"error",showClose:!0});return}se(a)}},se=async a=>{e.ticket=a;const t=e.id?`/api/parkingTransaction/${e.id}`:"/api/parkingTransaction";try{const r=await O(t,{method:e.id?"put":"post",body:e});p({message:r.message,type:"success"});const l=e.gate_out_id;le(l)}catch(r){p({message:r.response._data.message,type:"error",showClose:!0})}},pe=()=>{y.value=new WebSocket(`ws://${m.value.ip_address}:5678/`),y.value.onerror=a=>{p({message:"KONEKSI KE POS GAGAL",type:"error"})},y.value.onopen=a=>{console.log("POS TEKONEKSI")},y.value.onmessage=a=>{let t=JSON.parse(a.data);console.error(t)}},le=a=>{const t=m.value.gate_outs.find(r=>r.id==a);y.value.send(["open",t.device,t.baudrate,t.open_command,t.close_command].join(";")),setTimeout(re,2e3)},W=a=>{const t=m.value.gate_outs.find(r=>r.id==e.gate_out_id);t&&(!t.running_text_device||!t.running_text_baudrate||y.value.send(["rt",t.running_text_device,t.running_text_baudrate,a].join(";")))},ge=()=>{const a=m.value.gate_outs.find(t=>t.id==e.gate_out_id);a&&(!a.running_text_device||!a.running_text_baudrate||y.value.send(["rrt",a.running_text_device,a.running_text_baudrate].join(";")))},ae=async()=>{try{const a=await O("/api/parkingTransaction/printLastTransaction",{method:"post",body:{pos_id:e.pos_id}});p({message:a.message,type:"success",showClose:!0})}catch(a){p({message:a.response._data.message,type:"error",showClose:!0})}},ne=async()=>{let a={pos_id:e.pos_id,date:h().format("YYYY-MM-DD")};try{await O("/api/parkingTransaction/printReport",{method:"post",body:a}),p({message:"SILAKAN AMBIL STRUK",type:"success",showClose:!0})}catch(t){p({message:t.response._data.message,type:"error",showClose:!0})}},ye=async()=>{await K.getPos(),m.value&&(e.pos_id=m.value.id,m.value.gate_outs.length==1&&(e.gate_out_id=m.value.gate_outs[0].id),e.plat_nomor=c.value.plat_nomor_default,c.value.disable_plat_nomor?document.querySelector("#nomor-tiket").focus():document.querySelector("#plat-nomor").focus(),pe())},ue=async()=>{var a;try{const t=await O(`/api/parkingTransaction/takeSnapshot/${e.id}`,{method:"post",body:{gate_out_id:e.gate_out_id}});w.value=t,(a=d==null?void 0:d.proxy)==null||a.$forceUpdate()}catch(t){p({message:t.response._data.message,type:"error",showClose:!0})}};return fe(async()=>{await ye(),m.value&&(document.getElementById("gate-out-app").addEventListener("keydown",a=>{var t;a.key=="-"&&(a.preventDefault(),re(),(t=d==null?void 0:d.proxy)==null||t.$forceUpdate()),a.key=="+"&&(a.preventDefault(),e.nomor_barcode="",e.time_out="",e.jenis_kendaraan="",e.tarif="",document.querySelector("#nomor-tiket").focus()),a.key=="*"&&(a.preventDefault(),e.jenis_kendaraan="",e.tarif="",document.querySelector("#jenis-kendaraan").focus()),a.key=="/"&&(a.preventDefault(),e.time_in="",document.querySelector("#time-in").focus()),a.key=="F10"&&(a.preventDefault(),ne()),a.key=="F11"&&(a.preventDefault(),j.value=!0),a.key=="F12"&&(a.preventDefault(),ae())}),H.value=Ue(K.getJenisKendaraanList,6e4))}),Oe(()=>{y.value&&y.value.close(),clearInterval(H.value)}),(a,t)=>{const r=ke,l=be,x=Ye,E=De("mask");return n(m)?(f(),M("div",$e,[u("div",qe,[u("h1",Re,V(n(m).nama),1),n(c).disable_plat_nomor?F("",!0):(f(),L(l,{key:0,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Ve]),_:1}),s(r,{span:14},{default:i(()=>[I(u("input",{id:"plat-nomor",autocomplete:"off",onKeyup:v(z,["enter"]),type:"text",placeholder:"NO. PLAT","onUpdate:modelValue":t[0]||(t[0]=o=>n(e).plat_nomor=o),class:"my-input"},null,544),[[Z,n(e).plat_nomor]])]),_:1})]),_:1})),s(l,{gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Fe]),_:1}),s(r,{span:14},{default:i(()=>[I(u("input",{id:"nomor-tiket",autocomplete:"off",onKeyup:v(k,["enter"]),onKeydown:v(k,["tab"]),type:"text",placeholder:"NO. TIKET/KARTU","onUpdate:modelValue":t[1]||(t[1]=o=>n(e).nomor_barcode=o),class:"my-input"},null,544),[[Z,n(e).nomor_barcode]])]),_:1})]),_:1}),n(g).length>1?(f(),L(l,{key:1,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[He]),_:1}),s(r,{span:14},{default:i(()=>[I(u("select",{onChange:U,"onUpdate:modelValue":t[2]||(t[2]=o=>n(e).jenis_kendaraan=o),id:"jenis-kendaraan",class:"my-input",placeholder:"JENIS KENDARAAN"},[(f(!0),M(X,null,ee(n(g),o=>(f(),M("option",{value:o.nama,key:o.id},V(o.shortcut_key)+" - "+V(o.nama),9,Ge))),128))],544),[[ce,n(e).jenis_kendaraan]])]),_:1})]),_:1})):F("",!0),I(s(l,{gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Je]),_:1}),s(r,{span:14},{default:i(()=>[I(u("input",{onKeyup:v(G,["enter"]),onChange:U,id:"time-in","onUpdate:modelValue":t[3]||(t[3]=o=>n(e).time_in=o),class:"my-input"},null,544),[[E,"####-##-## ##:##"],[Z,n(e).time_in]])]),_:1})]),_:1},512),[[me,n(e).nomor_barcode=="xxxxx"]]),n(A).length>1?I((f(),L(l,{key:2,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[ze]),_:1}),s(r,{span:14},{default:i(()=>[I(u("select",{onChange:te,"onUpdate:modelValue":t[4]||(t[4]=o=>n(e).gate_in_id=o),id:"gate-in",class:"my-input"},[(f(!0),M(X,null,ee(n(A),o=>(f(),M("option",{value:o.id,key:o.id},V(o.shortcut_key)+" - "+V(o.nama),9,We))),128))],544),[[ce,n(e).gate_in_id]])]),_:1})]),_:1},512)),[[me,n(e).nomor_barcode=="xxxxx"]]):F("",!0),s(l,{gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Qe]),_:1}),s(r,{span:14},{default:i(()=>[I(u("input",{disabled:"","onUpdate:modelValue":t[5]||(t[5]=o=>n(e).tarif=o),class:"my-input bg-red-700 text-white"},null,512),[[Z,n(e).tarif]])]),_:1})]),_:1}),n(e).nomor_barcode=="xxxxx"?(f(),L(l,{key:3,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Ze]),_:1}),s(r,{span:14},{default:i(()=>[u("input",{disabled:"",value:Number(n(e).tarif)+Number(n(e).denda),class:"my-input bg-red-700 text-white"},null,8,Xe)]),_:1})]),_:1})):F("",!0),u("button",{id:"submit-btn",onKeyup:[v(J,["right"]),v(J,["down"])],onKeydown:t[6]||(t[6]=v(o=>ie(!1),["enter"])),class:"my-big-btn",onClick:t[7]||(t[7]=o=>ie(!1))}," BUKA GATE ",32),u("button",{id:"submit-btn1",onKeyup:[v(R,["left"]),v(R,["up"])],onKeydown:v(ae,["enter"]),class:"my-big-btn",onClick:ae}," [F12] PRINT STRUK TRANSAKSI TERAKHIR ",32),s(l,{gutter:10},{default:i(()=>[s(r,{span:12},{default:i(()=>[u("button",{onKeydown:v(ne,["enter"]),class:"my-big-btn",onClick:ne}," [F10] PRINT LAPORAN ",32)]),_:1}),s(r,{span:12},{default:i(()=>[u("button",{class:"my-big-btn",onKeydown:t[8]||(t[8]=v(o=>j.value=!0,["enter"])),onClick:t[9]||(t[9]=o=>j.value=!0)}," [F11] BUKA GATE MANUAL ",32)]),_:1})]),_:1})]),u("div",{class:Ce({"ml-5":!0,flex:n(c).orientasi_kamera=="POTRAIT"}),style:{width:"100%"}},[(f(!0),M(X,null,ee(n(w),o=>(f(),M("div",{class:"mb-1",style:{width:"100%"},key:o.id},[u("img",{src:o.url,style:{width:"700px"}},null,8,et)]))),128))],2),s(x,{show:n(j),onClose:t[10]||(t[10]=o=>j.value=!1),gateOutList:n(m).gate_outs,onOpenGate:t[11]||(t[11]=o=>le(o))},null,8,["show","gateOutList"])])):(f(),M("div",tt,nt))}}},pt=Ie(ot,[["__scopeId","data-v-6aade1cc"]]);export{pt as default};
