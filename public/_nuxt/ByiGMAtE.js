import{E as he,a as xe}from"./DackE5MS.js";import{u as ie,a as we,b as Se}from"./DTX7Vt5Z.js";import{s as pe}from"./IP4pgu5I.js";import{r as H,X as Te,a2 as ge,t as f,v as S,W as J,I as o,V as z,o as ye,T as q,A as i,z as s,B as ce,U as G,_ as Ae,Q as Me,c as Y,x as u,y as F,G as O,a3 as _e,a0 as x,K as Ke,a4 as je,$ as ee,Z as fe,a1 as Ie,C as Ee,D as Ne}from"./BPBBqX13.js";import{l as Oe,s as De,t as y,o as Ce,E as Le}from"./B9wLchKa.js";import{E as $e,a as qe}from"./COawGGrN.js";import{E as Be,u as Pe}from"./DGA5DoMI.js";import"./BOIZsV8L.js";import{E as te}from"./Dh-lkO53.js";import{h as w}from"./C5S46NFB.js";const Ue=["src"],Ye={__name:"Kamera",setup(T){const{api:A,tableData:M,requestData:K}=ie("/api/kamera"),l=H({}),k=pe(()=>{M.value.data.forEach(({id:v})=>{A(`/api/kamera/test/${v}`).then(p=>{l.value[v]="data:image/jpeg;base64,"+p.snapshot})})},1e3);return Te(()=>{K()}),ge(()=>clearInterval(k)),(v,p)=>(f(!0),S(z,null,J(o(M).data,C=>(f(),S("img",{style:{width:"300px"},key:C.id,src:o(l)[C.id],alt:"Snapshot"},null,8,Ue))),128))}},Re={__name:"FormBukaManual",props:["show","gateOutList"],emits:["close","open-gate"],setup(T,{emit:A}){const{show:M,gateOutList:K}=T,{api:l,formModel:e,formErrors:k}=ie("/api/manualOpenLog"),v=A,p=()=>{e.value={},k.value={},v("close")},C=()=>{te.confirm("Aksi ini akan dicatat oleh sistem. Anda yakin?","Peringatan",{type:"warning"}).then(()=>l("/api/manualOpenLog",{method:"POST",body:e.value})).then(d=>{y({message:d.message,type:"success"}),v("open-gate",e.value.gate_out_id),p()}).catch(d=>{var c;((c=d.response)==null?void 0:c.status)==422&&(k.value=d.response._data.errors)})};return ye(()=>{K.length==1&&(e.value.gate_out_id=K[0].id)}),(d,c)=>{const j=Ce,b=$e,B=we,P=Se,ae=qe,W=Le,Q=Be;return f(),q(Q,{center:"",title:"FORM BUKA MANUAL","model-value":T.show,"before-close":p},{footer:i(()=>[s(W,{icon:o(Oe),onClick:p},{default:i(()=>[ce(" BATAL ")]),_:1},8,["icon"]),s(W,{icon:o(De),type:"primary",onClick:C},{default:i(()=>[ce(" SIMPAN ")]),_:1},8,["icon"])]),default:i(()=>[s(ae,{"label-position":"left","label-width":"200px"},{default:i(()=>{var R,U,X;return[s(b,{label:"Alasan buka manual",error:(R=o(k).alasan)==null?void 0:R.join(", ")},{default:i(()=>[s(j,{autofocus:"",type:"textarea",modelValue:o(e).alasan,"onUpdate:modelValue":c[0]||(c[0]=h=>o(e).alasan=h),rows:"3",placeholder:"Alasan buka manual"},null,8,["modelValue"])]),_:1},8,["error"]),T.gateOutList.length>1?(f(),q(b,{key:0,label:"Gate Keluar",error:(U=o(k).gate_out_id)==null?void 0:U.join(", ")},{default:i(()=>[s(P,{modelValue:o(e).gate_out_id,"onUpdate:modelValue":c[1]||(c[1]=h=>o(e).gate_out_id=h),style:{width:"100%"},placeholder:"Gate Keluar"},{default:i(()=>[(f(!0),S(z,null,J(T.gateOutList,h=>(f(),q(B,{key:h.id,label:h.nama,value:h.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["error"])):G("",!0),s(b,{label:"Masukkan password Admin",error:(X=o(k).password)==null?void 0:X.join(", ")},{default:i(()=>[s(j,{type:"password",modelValue:o(e).password,"onUpdate:modelValue":c[2]||(c[2]=h=>o(e).password=h),placeholder:"Password"},null,8,["modelValue"])]),_:1},8,["error"])]}),_:1})]),_:1},8,["model-value"])}}},D=T=>(Ee("data-v-f36f66e9"),T=T(),Ne(),T),Ve={key:0,class:"flex",id:"gate-out-app",style:{height:"calc(100vh - 100px)"},tabindex:"1"},Fe={style:{width:"600px","flex-shrink":"0"}},He={class:"mt-0 mb-3 p-2 bg-red text-white text-center text-xl"},Ge=D(()=>u("div",{class:"label-big"},"[-] NO. PLAT",-1)),Je=D(()=>u("div",{class:"label-big"},"[+] NO. TIKET/KARTU",-1)),ze=D(()=>u("div",{class:"label-big"},"[*] JENIS KENDARAAN",-1)),We=["value"],Qe=D(()=>u("div",{class:"label-big"},"[*] JAM MASUK",-1)),Xe=D(()=>u("div",{class:"label-big"},"GATE MASUK",-1)),Ze=["value"],et=D(()=>u("div",{class:"label-big"},"TARIF",-1)),tt=D(()=>u("div",{class:"label-big"},"TARIF + DENDA",-1)),at=["value"],nt=["src"],ot={key:1,class:"flex flex-row justify-content-center align-items-center",style:{height:"calc(100vh - 145px)"}},rt=D(()=>u("div",{class:"text-center text-5xl text-danger"}," KOMPUTER INI TIDAK TERDAFTAR SEBAGAI POS ",-1)),it=[rt],st={__name:"index",setup(T){const A=Pe(),{api:M,toRupiah:K}=ie(),l=Ie(),e=Me({nomor_barcode:"",tarif:"",denda:""}),k=H([]),v=H(!1),p=H(null),C=H(null),d=Y(()=>A.pos),c=Y(()=>A.setting),j=Y(()=>A.gateInList),b=Y(()=>A.jenisKendaraanList),B=Y(()=>{if(!e.time_in||!e.time_out)return"00:00:00";let a=w(e.time_in),t=w(e.time_out),r=t.diff(a,"days"),m=t.diff(a,"hours"),g=t.diff(a,"minutes");return`${r}HR ${String(m%24).padStart(2,"0")}:${String(g%60).padStart(2,"0")}`}),P=Y(()=>Number(e.tarif)+Number(e.denda)),ae=()=>{Z(`${B}|${K(P)}`),document.querySelector("#submit-btn").focus()},W=()=>{j.value.length==1&&(e.gate_in_id=j.value[0].id),e.gate_in_id?document.querySelector("#submit-btn").focus():document.querySelector("#gate-in").focus(),Z(`${B}|${K(P)}`)},Q=()=>{document.querySelector("#submit-btn1").focus()},R=()=>{document.querySelector("#submit-btn").focus()},U=()=>{e.group=b.value.find(_=>_.nama==e.jenis_kendaraan).group;const a=d.value.gate_outs.find(_=>_.jenis_kendaraan.includes(e.jenis_kendaraan));if(!a){y({message:"Tidak ada gate keluar untuk jenis kendaraan terkait",type:"error"});return}if(e.gate_out_id=a.id,e.id&&me(),e.is_member){e.tarif=0,document.querySelector("#submit-btn").focus();return}const t=b.value.find(_=>_.nama==e.jenis_kendaraan);if(!t){y({message:"Tarif tidak ditemukan untuk jenis kendaraan "+e.jenis_kendaraan,type:"error",showClose:!0}),e.tarif=0;return}e.nomor_barcode.toLowerCase()=="xxxxx"?e.denda=Number(t.denda_tiket_hilang):e.denda=0;let r=w(e.time_in),m=e.time_out?w(e.time_out):w(),g=m.diff(r,"minutes")||1,E=t.tarif_menit_pertama;if(g<=t.menit_pertama){e.tarif=E,document.querySelector("#submit-btn").focus(),Z(`${B}|${K(P)}`);return}let V=g-t.menit_pertama,n;if(t.mode_menginap==0&&(n=Math.ceil(g/(60*24)),n==0&&t.mode_tarif==0&&(n=1)),t.mode_menginap==1){let _=w(r.format("YYYY-MM-DD")),N=w(m.format("YYYY-MM-DD"));n=0,g>=60?n=N.diff(_,"days")+1:n=1}let I=n>=1?n-1:0,L=I*t.tarif_menginap;if(t.mode_tarif==0&&(e.tarif=E+n*t.tarif_flat+L),t.mode_tarif==1){let _=I*t.tarif_maksimum;if(t.mode_menginap==0){const N=g%1440;let $=0;N<=t.menit_pertama?$=t.tarif_menit_pertama:$=t.tarif_menit_pertama+Math.ceil((N-t.menit_pertama)/t.menit_selanjutnya)*t.tarif_menit_selanjutnya,$>t.tarif_maksimum&&($=t.tarif_maksimum),e.tarif=_+$+L}if(t.mode_menginap==1)if(n>1){let N=w(r.format("YYYY-MM-DD")+" 24:00:00").diff(r,"minutes")-t.menit_pertama,$=m.diff(w(m.format("YYYY-MM-DD")+" 00:00:00"),"minutes"),re=Math.ceil(N/t.menit_selanjutnya)*t.tarif_menit_selanjutnya;tarifHariTerakhir=Math.ceil($/t.menit_selanjutnya)*t.tarif_menit_selanjutnya,re>t.tarif_maksimum&&(re=t.tarif_maksimum),tarifHariTerakhir>t.tarif_maksimum&&(tarifHariTerakhir=t.tarif_maksimum),n<=2&&(_=0),e.tarif=E+_+re+tarifHariTerakhir+L}else tarifHariPertama=Math.ceil(V/t.menit_selanjutnya)*t.tarif_menit_selanjutnya,tarifHariPertama>t.tarif_maksimum&&(tarifHariPertama=t.tarif_maksimum),e.tarif=E+tarifHariPertama}e.nomor_barcode.toLowerCase()=="xxxxx"?document.querySelector("#time-in").focus():document.querySelector("#submit-btn").focus(),Z(`${B}|${K(P)}`)},X=()=>{let a={plat_nomor:e.plat_nomor};M("/api/member/search",{method:"get",query:a}).then(t=>{e.is_member=1,e.tarif=0}).catch(t=>{e.is_member=0}).finally(()=>{var t;document.querySelector("#nomor-tiket").focus(),(t=l==null?void 0:l.proxy)==null||t.$forceUpdate()})},h=async()=>{var t,r,m;if(e.nomor_barcode.length<5)return;let a=w().format("YYYY-MM-DD HH:mm:ss");if(e.nomor_barcode.toLowerCase()=="xxxxx"){e.time_in=w().format("YYYY-MM-DD"),(t=l==null?void 0:l.proxy)==null||t.$forceUpdate(),e.time_out=a,b.value.length>1?document.querySelector("#jenis-kendaraan").focus():(e.jenis_kendaraan=b.value[0].nama,document.querySelector("#time-in").focus());return}try{let g=await M("/api/parkingTransaction/search",{query:{nomor_barcode:e.nomor_barcode}});k.value=g.snapshots;const{id:E,gate_in_id:V,is_member:n,member:I}=g;if(e.id=E,e.gate_in_id=V,e.is_member=n,e.time_out=a,e.tarif=0,(r=l==null?void 0:l.proxy)==null||r.$forceUpdate(),!n&&b.value.length>1){document.querySelector("#jenis-kendaraan").focus();return}if(n){if(I.expired)return te.alert("Kartu telah habis masa berlaku","Perhatian",{type:"warning",center:!0,roundButton:!0,confirmButtonText:"OK",confirmButtonClass:"bg-red"}),e.is_member=0,!1;if(!I.expired&&I.expired_in<=5&&te.alert(`Kartu akan habis masa berlaku dalam ${I.expired_in} hari`,"Perhatian",{type:"warning",center:!0,roundButton:!0,confirmButtonText:"OK",confirmButtonClass:"bg-red"}),c.value.disable_plat_nomor){document.querySelector("#submit-btn").focus();const L=g.member.vehicles[0];e.jenis_kendaraan=L.jenis_kendaraan,e.plat_nomor=L.plat_nomor;const _=d.value.gate_outs.find(N=>N.jenis_kendaraan.includes(e.jenis_kendaraan));if(!_){y({message:"Tidak ada gate keluar untuk jenis kendaraan terkait",type:"error"});return}e.gate_out_id=_.id,c.value.member_auto_open&&(e.id&&me(),ue(!1))}else I.vehicles.find(_=>_.plat_nomor==e.plat_nomor)?b.value.length>1&&document.querySelector("#jenis-kendaraan").focus():(te.alert("Plat nomor tidak cocok dengan kartu. Nomor plat yang terdaftar adalah "+I.vehicles.map(_=>_.plat_nomor).join(", "),"Perhatian",{type:"warning",center:!0,roundButton:!0,confirmButtonText:"OK",confirmButtonClass:"bg-red"}),document.querySelector("#plat-nomor").focus())}b.value.length==1&&(e.jenis_kendaraan=b.value[0].nama,U())}catch(g){((m=g.response)==null?void 0:m.status)==404&&y({message:g.response._data.message,type:"error",center:!0,showClose:!0,duration:3e3}),document.querySelector("#nomor-tiket").focus()}},se=()=>{var a;ke(),e.tarif="",e.denda="",e.gate_in_id=null,e.gate_out_id=null,e.jenis_kendaraan=null,e.plat_nomor=c.value.plat_nomor_default,e.nomor_barcode="",e.time_out="",e.time_in=void 0,e.duration="",k.value=[],(a=l==null?void 0:l.proxy)==null||a.$forceUpdate(),c.value.disable_plat_nomor?(console.log("ke nomor tiket"),document.querySelector("#nomor-tiket").focus()):(console.log("ke plat nomor"),document.querySelector("#plat-nomor").focus())},le=a=>{var t;if(console.log(e),e.nomor_barcode.toLowerCase()=="xxxxx"&&!e.time_in){document.querySelector("#time-in").focus();return}else document.querySelector("#submit-btn").blur();if(j.value.length==1&&(e.gate_in_id=j.value[0].id),!e.gate_in_id){y({message:"MOHON ISI GATE IN",type:"error",showClose:!0});return}if(!(!e.nomor_barcode||!e.gate_out_id||!e.jenis_kendaraan||!e.time_out)){if(((t=e.time_in)==null?void 0:t.length)<16){y({message:"FORMAT TIME IN SALAH",type:"error",showClose:!0});return}ue(a)}},ue=async a=>{e.ticket=a;const t=e.id?`/api/parkingTransaction/${e.id}`:"/api/parkingTransaction";try{const r=await M(t,{method:e.id?"put":"post",body:e});y({message:r.message,type:"success"});const m=e.gate_out_id;de(m)}catch(r){y({message:r.response._data.message,type:"error",showClose:!0})}},be=()=>{p.value=new WebSocket(`ws://${d.value.ip_address}:5678/`),p.value.onerror=a=>{y({message:"KONEKSI KE POS GAGAL",type:"error"})},p.value.onopen=a=>{console.log("POS TEKONEKSI")},p.value.onmessage=a=>{let t=JSON.parse(a.data);console.error(t)}},de=a=>{const t=d.value.gate_outs.find(r=>r.id==a);p.value.send(["open",t.device,t.baudrate,t.open_command,t.close_command].join(";")),setTimeout(se,1e3)},Z=a=>{const t=d.value.gate_outs.find(r=>r.id==e.gate_out_id);t&&(!t.running_text_device||!t.running_text_baudrate||p.value.send(["rt",t.running_text_device,t.running_text_baudrate,a].join(";")))},ke=()=>{const a=d.value.gate_outs.find(t=>t.id==e.gate_out_id);a&&(!a.running_text_device||!a.running_text_baudrate||p.value.send(["rrt",a.running_text_device,a.running_text_baudrate].join(";")))},ne=async()=>{try{const a=await M("/api/parkingTransaction/printLastTransaction",{method:"post",body:{pos_id:e.pos_id}});y({message:a.message,type:"success",showClose:!0})}catch(a){y({message:a.response._data.message,type:"error",showClose:!0})}},oe=async()=>{let a={pos_id:e.pos_id,date:w().format("YYYY-MM-DD")};try{await M("/api/parkingTransaction/printReport",{method:"post",body:a}),y({message:"SILAKAN AMBIL STRUK",type:"success",showClose:!0})}catch(t){y({message:t.response._data.message,type:"error",showClose:!0})}},ve=async()=>{await A.getPos(),d.value&&(e.pos_id=d.value.id,d.value.gate_outs.length==1&&(e.gate_out_id=d.value.gate_outs[0].id),e.plat_nomor=c.value.plat_nomor_default,c.value.disable_plat_nomor?document.querySelector("#nomor-tiket").focus():document.querySelector("#plat-nomor").focus(),be())},me=async()=>{var a;try{const t=await M(`/api/parkingTransaction/takeSnapshot/${e.id}`,{method:"post",body:{gate_out_id:e.gate_out_id}});k.value=t,(a=l==null?void 0:l.proxy)==null||a.$forceUpdate()}catch(t){y({message:t.response._data.message,type:"error",showClose:!0})}};return ye(async()=>{await ve(),d.value&&(document.getElementById("gate-out-app").addEventListener("keydown",a=>{var t;a.key=="-"&&(a.preventDefault(),se(),(t=l==null?void 0:l.proxy)==null||t.$forceUpdate()),a.key=="+"&&(a.preventDefault(),e.nomor_barcode="",e.time_out="",e.jenis_kendaraan="",e.tarif="",document.querySelector("#nomor-tiket").focus()),a.key=="*"&&(a.preventDefault(),e.jenis_kendaraan="",e.tarif="",document.querySelector("#jenis-kendaraan").focus()),a.key=="/"&&(a.preventDefault(),e.time_in="",document.querySelector("#time-in").focus()),a.key=="F10"&&(a.preventDefault(),oe()),a.key=="F11"&&(a.preventDefault(),v.value=!0),a.key=="F12"&&(a.preventDefault(),ne())}),C.value=pe(A.getJenisKendaraanList,6e4))}),ge(()=>{p.value&&p.value.close(),clearInterval(C.value)}),(a,t)=>{const r=xe,m=he,g=Ye,E=Re,V=je("mask");return o(d)?(f(),S("div",Ve,[u("div",Fe,[u("h1",He,F(o(d).nama),1),o(c).disable_plat_nomor?G("",!0):(f(),q(m,{key:0,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Ge]),_:1}),s(r,{span:14},{default:i(()=>[O(u("input",{id:"plat-nomor",autocomplete:"off",onKeyup:x(X,["enter"]),type:"text",placeholder:"NO. PLAT","onUpdate:modelValue":t[0]||(t[0]=n=>o(e).plat_nomor=n),class:"my-input"},null,544),[[ee,o(e).plat_nomor]])]),_:1})]),_:1})),s(m,{gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Je]),_:1}),s(r,{span:14},{default:i(()=>[O(u("input",{id:"nomor-tiket",autocomplete:"off",onKeyup:x(h,["enter"]),onKeydown:x(h,["tab"]),type:"text",placeholder:"NO. TIKET/KARTU","onUpdate:modelValue":t[1]||(t[1]=n=>o(e).nomor_barcode=n),class:"my-input"},null,544),[[ee,o(e).nomor_barcode]])]),_:1})]),_:1}),o(b).length>1?(f(),q(m,{key:1,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[ze]),_:1}),s(r,{span:14},{default:i(()=>[O(u("select",{onChange:U,"onUpdate:modelValue":t[2]||(t[2]=n=>o(e).jenis_kendaraan=n),id:"jenis-kendaraan",class:"my-input",placeholder:"JENIS KENDARAAN"},[(f(!0),S(z,null,J(o(b),n=>(f(),S("option",{value:n.nama,key:n.id},F(n.shortcut_key)+" - "+F(n.nama),9,We))),128))],544),[[fe,o(e).jenis_kendaraan]])]),_:1})]),_:1})):G("",!0),O(s(m,{gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Qe]),_:1}),s(r,{span:14},{default:i(()=>[O(u("input",{onKeyup:x(W,["enter"]),onChange:U,id:"time-in","onUpdate:modelValue":t[3]||(t[3]=n=>o(e).time_in=n),class:"my-input"},null,544),[[V,"####-##-## ##:##"],[ee,o(e).time_in]])]),_:1})]),_:1},512),[[_e,o(e).nomor_barcode=="xxxxx"]]),o(j).length>1?O((f(),q(m,{key:2,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Xe]),_:1}),s(r,{span:14},{default:i(()=>[O(u("select",{onChange:ae,"onUpdate:modelValue":t[4]||(t[4]=n=>o(e).gate_in_id=n),id:"gate-in",class:"my-input"},[(f(!0),S(z,null,J(o(j),n=>(f(),S("option",{value:n.id,key:n.id},F(n.shortcut_key)+" - "+F(n.nama),9,Ze))),128))],544),[[fe,o(e).gate_in_id]])]),_:1})]),_:1},512)),[[_e,o(e).nomor_barcode=="xxxxx"]]):G("",!0),s(m,{gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[et]),_:1}),s(r,{span:14},{default:i(()=>[O(u("input",{disabled:"","onUpdate:modelValue":t[5]||(t[5]=n=>o(e).tarif=n),class:"my-input bg-red-700 text-white"},null,512),[[ee,o(e).tarif]])]),_:1})]),_:1}),o(e).nomor_barcode=="xxxxx"?(f(),q(m,{key:3,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[tt]),_:1}),s(r,{span:14},{default:i(()=>[u("input",{disabled:"",value:Number(o(e).tarif)+Number(o(e).denda),class:"my-input bg-red-700 text-white"},null,8,at)]),_:1})]),_:1})):G("",!0),u("button",{id:"submit-btn",onKeyup:[x(Q,["right"]),x(Q,["down"])],onKeydown:t[6]||(t[6]=x(n=>le(!1),["enter"])),class:"my-big-btn",onClick:t[7]||(t[7]=n=>le(!1))}," BUKA GATE ",32),u("button",{id:"submit-btn1",onKeyup:[x(R,["left"]),x(R,["up"])],onKeydown:x(ne,["enter"]),class:"my-big-btn",onClick:ne}," [F12] PRINT STRUK TRANSAKSI TERAKHIR ",32),s(m,{gutter:10},{default:i(()=>[s(r,{span:12},{default:i(()=>[u("button",{onKeydown:x(oe,["enter"]),class:"my-big-btn",onClick:oe}," [F10] PRINT LAPORAN ",32)]),_:1}),s(r,{span:12},{default:i(()=>[u("button",{class:"my-big-btn",onKeydown:t[8]||(t[8]=x(n=>v.value=!0,["enter"])),onClick:t[9]||(t[9]=n=>v.value=!0)}," [F11] BUKA GATE MANUAL ",32)]),_:1})]),_:1})]),s(g),u("div",{class:Ke({"ml-5":!0,flex:o(c).orientasi_kamera=="POTRAIT"}),style:{width:"100%"}},[(f(!0),S(z,null,J(o(k),n=>(f(),S("div",{class:"mb-1",style:{width:"100%"},key:n.id},[u("img",{src:n.url,style:{width:"700px"}},null,8,nt)]))),128))],2),s(E,{show:o(v),onClose:t[10]||(t[10]=n=>v.value=!1),gateOutList:o(d).gate_outs,onOpenGate:t[11]||(t[11]=n=>de(n))},null,8,["show","gateOutList"])])):(f(),S("div",ot,it))}}},bt=Ae(st,[["__scopeId","data-v-f36f66e9"]]);export{bt as default};
