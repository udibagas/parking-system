import{E as ke,a as ve}from"./Ch6bUF77.js";import{l as he,s as xe,t as y,o as we,E as Se}from"./CuCUYCFY.js";import{E as Te,a as Ae}from"./BAj_rVXT.js";import{u as fe,a as Me,b as Ke}from"./DU7B1xwq.js";import{E as je,u as Ie}from"./D16dizLH.js";import"./DrHaS6k5.js";import{E as X}from"./CELvrH87.js";import{o as pe,t as p,T as q,A as i,z as s,I as n,B as me,v as M,V as ee,W as te,U as F,_ as Ee,Q as Ne,r as Q,c as $,a2 as Oe,x as l,y as V,G as N,a3 as ce,a0 as h,K as Ce,a4 as De,$ as Z,Z as _e,a1 as Le,C as Pe,D as qe}from"./By0PGofw.js";import{s as Be}from"./7f-kfXoG.js";import{h as x}from"./C5S46NFB.js";const Ue={__name:"FormBukaManual",props:["show","gateOutList"],emits:["close","open-gate"],setup(S,{emit:K}){const{show:C,gateOutList:D}=S,{api:u,formModel:e,formErrors:w}=fe("/api/manualOpenLog"),j=K,k=()=>{e.value={},w.value={},j("close")},H=()=>{X.confirm("Aksi ini akan dicatat oleh sistem. Anda yakin?","Peringatan",{type:"warning"}).then(()=>u("/api/manualOpenLog",{method:"POST",body:e.value})).then(d=>{y({message:d.message,type:"success"}),j("open-gate",e.value.gate_out_id),k()}).catch(d=>{var c;((c=d.response)==null?void 0:c.status)==422&&(w.value=d.response._data.errors)})};return pe(()=>{D.length==1&&(e.value.gate_out_id=D[0].id)}),(d,c)=>{const T=we,b=Te,B=Me,U=Ke,ae=Ae,G=Se,J=je;return p(),q(J,{center:"",title:"FORM BUKA MANUAL","model-value":S.show,"before-close":k},{footer:i(()=>[s(G,{icon:n(he),onClick:k},{default:i(()=>[me(" BATAL ")]),_:1},8,["icon"]),s(G,{icon:n(xe),type:"primary",onClick:H},{default:i(()=>[me(" SIMPAN ")]),_:1},8,["icon"])]),default:i(()=>[s(ae,{"label-position":"left","label-width":"200px"},{default:i(()=>{var R,Y,z;return[s(b,{label:"Alasan buka manual",error:(R=n(w).alasan)==null?void 0:R.join(", ")},{default:i(()=>[s(T,{autofocus:"",type:"textarea",modelValue:n(e).alasan,"onUpdate:modelValue":c[0]||(c[0]=v=>n(e).alasan=v),rows:"3",placeholder:"Alasan buka manual"},null,8,["modelValue"])]),_:1},8,["error"]),S.gateOutList.length>1?(p(),q(b,{key:0,label:"Gate Keluar",error:(Y=n(w).gate_out_id)==null?void 0:Y.join(", ")},{default:i(()=>[s(U,{modelValue:n(e).gate_out_id,"onUpdate:modelValue":c[1]||(c[1]=v=>n(e).gate_out_id=v),style:{width:"100%"},placeholder:"Gate Keluar"},{default:i(()=>[(p(!0),M(ee,null,te(S.gateOutList,v=>(p(),q(B,{key:v.id,label:v.nama,value:v.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["error"])):F("",!0),s(b,{label:"Masukkan password Admin",error:(z=n(w).password)==null?void 0:z.join(", ")},{default:i(()=>[s(T,{type:"password",modelValue:n(e).password,"onUpdate:modelValue":c[2]||(c[2]=v=>n(e).password=v),placeholder:"Password"},null,8,["modelValue"])]),_:1},8,["error"])]}),_:1})]),_:1},8,["model-value"])}}},O=S=>(Pe("data-v-68ff1853"),S=S(),qe(),S),Ye={key:0,class:"flex",id:"gate-out-app",style:{height:"calc(100vh - 100px)"},tabindex:"1"},$e={style:{width:"600px","flex-shrink":"0"}},Re={class:"mt-0 mb-3 p-2 bg-red text-white text-center text-xl"},Ve=O(()=>l("div",{class:"label-big"},"[-] NO. PLAT",-1)),Fe=O(()=>l("div",{class:"label-big"},"[+] NO. TIKET/KARTU",-1)),He=O(()=>l("div",{class:"label-big"},"[*] JENIS KENDARAAN",-1)),Ge=["value"],Je=O(()=>l("div",{class:"label-big"},"[*] JAM MASUK",-1)),ze=O(()=>l("div",{class:"label-big"},"GATE MASUK",-1)),We=["value"],Qe=O(()=>l("div",{class:"label-big"},"TARIF",-1)),Ze=O(()=>l("div",{class:"label-big"},"TARIF + DENDA",-1)),Xe=["value"],et=["src"],tt={key:1,class:"flex flex-row justify-content-center align-items-center",style:{height:"calc(100vh - 145px)"}},at=O(()=>l("div",{class:"text-center text-5xl text-danger"}," KOMPUTER INI TIDAK TERDAFTAR SEBAGAI POS ",-1)),nt=[at],ot={__name:"index",setup(S){const K=Ie(),{api:C,toRupiah:D}=fe(),u=Le(),e=Ne({nomor_barcode:"",tarif:"",denda:""}),w=Q([]),j=Q(!1),k=Q(null),H=Q(null),d=$(()=>K.pos),c=$(()=>K.setting),T=$(()=>K.gateInList),b=$(()=>K.jenisKendaraanList),B=$(()=>{if(!e.time_in||!e.time_out)return"00:00:00";let a=x(e.time_in),t=x(e.time_out),r=t.diff(a,"days"),m=t.diff(a,"hours"),f=t.diff(a,"minutes");return`${r}HR ${String(m%24).padStart(2,"0")}:${String(f%60).padStart(2,"0")}`}),U=$(()=>Number(e.tarif)+Number(e.denda)),ae=()=>{W(`${B}|${D(U)}`),document.querySelector("#submit-btn").focus()},G=()=>{T.value.length==1&&(e.gate_in_id=T.value[0].id),e.gate_in_id?document.querySelector("#submit-btn").focus():document.querySelector("#gate-in").focus(),W(`${B}|${D(U)}`)},J=()=>{document.querySelector("#submit-btn1").focus()},R=()=>{document.querySelector("#submit-btn").focus()},Y=()=>{e.group=b.value.find(_=>_.nama==e.jenis_kendaraan).group;const a=d.value.gate_outs.find(_=>_.jenis_kendaraan.includes(e.jenis_kendaraan));if(!a){y({message:"Tidak ada gate keluar untuk jenis kendaraan terkait",type:"error"});return}if(e.gate_out_id=a.id,e.id&&de(),e.is_member){e.tarif=0,document.querySelector("#submit-btn").focus();return}const t=b.value.find(_=>_.nama==e.jenis_kendaraan);if(!t){y({message:"Tarif tidak ditemukan untuk jenis kendaraan "+e.jenis_kendaraan,type:"error",showClose:!0}),e.tarif=0;return}e.nomor_barcode.toLowerCase()=="xxxxx"?e.denda=Number(t.denda_tiket_hilang):e.denda=0;let r=x(e.time_in),m=e.time_out?x(e.time_out):x(),f=m.diff(r,"minutes")||1,I=t.tarif_menit_pertama;if(f<=t.menit_pertama){e.tarif=I,document.querySelector("#submit-btn").focus(),W(`${B}|${D(U)}`);return}let o=f-t.menit_pertama,g;if(t.mode_menginap==0&&(g=Math.ceil(f/(60*24)),g==0&&t.mode_tarif==0&&(g=1)),t.mode_menginap==1){let _=x(r.format("YYYY-MM-DD")),E=x(m.format("YYYY-MM-DD"));g=0,f>=60?g=E.diff(_,"days")+1:g=1}let A=g>=1?g-1:0,L=A*t.tarif_menginap;if(t.mode_tarif==0&&(e.tarif=I+g*t.tarif_flat+L),t.mode_tarif==1){let _=A*t.tarif_maksimum;if(t.mode_menginap==0){const E=f%1440;let P=0;E<=t.menit_pertama?P=t.tarif_menit_pertama:P=t.tarif_menit_pertama+Math.ceil((E-t.menit_pertama)/t.menit_selanjutnya)*t.tarif_menit_selanjutnya,P>t.tarif_maksimum&&(P=t.tarif_maksimum),e.tarif=_+P+L}if(t.mode_menginap==1)if(g>1){let E=x(r.format("YYYY-MM-DD")+" 24:00:00").diff(r,"minutes")-t.menit_pertama,P=m.diff(x(m.format("YYYY-MM-DD")+" 00:00:00"),"minutes"),re=Math.ceil(E/t.menit_selanjutnya)*t.tarif_menit_selanjutnya;tarifHariTerakhir=Math.ceil(P/t.menit_selanjutnya)*t.tarif_menit_selanjutnya,re>t.tarif_maksimum&&(re=t.tarif_maksimum),tarifHariTerakhir>t.tarif_maksimum&&(tarifHariTerakhir=t.tarif_maksimum),g<=2&&(_=0),e.tarif=I+_+re+tarifHariTerakhir+L}else tarifHariPertama=Math.ceil(o/t.menit_selanjutnya)*t.tarif_menit_selanjutnya,tarifHariPertama>t.tarif_maksimum&&(tarifHariPertama=t.tarif_maksimum),e.tarif=I+tarifHariPertama}e.nomor_barcode.toLowerCase()=="xxxxx"?document.querySelector("#time-in").focus():document.querySelector("#submit-btn").focus(),W(`${B}|${D(U)}`)},z=()=>{let a={plat_nomor:e.plat_nomor};C("/api/member/search",{method:"get",query:a}).then(t=>{e.is_member=1,e.tarif=0}).catch(t=>{e.is_member=0}).finally(()=>{var t;document.querySelector("#nomor-tiket").focus(),(t=u==null?void 0:u.proxy)==null||t.$forceUpdate()})},v=async()=>{var t,r,m;if(e.nomor_barcode.length<5)return;let a=x().format("YYYY-MM-DD HH:mm:ss");if(e.nomor_barcode.toLowerCase()=="xxxxx"){e.time_in=x().format("YYYY-MM-DD"),(t=u==null?void 0:u.proxy)==null||t.$forceUpdate(),e.time_out=a,b.value.length>1?document.querySelector("#jenis-kendaraan").focus():(e.jenis_kendaraan=b.value[0].nama,document.querySelector("#time-in").focus());return}try{let f=await C("/api/parkingTransaction/search",{query:{nomor_barcode:e.nomor_barcode}});w.value=f.snapshots;const{id:I,gate_in_id:o,is_member:g,member:A}=f;if(e.id=I,e.gate_in_id=o,e.is_member=g,e.time_out=a,e.tarif=0,(r=u==null?void 0:u.proxy)==null||r.$forceUpdate(),!g&&b.value.length>1){document.querySelector("#jenis-kendaraan").focus();return}if(g){if(A.expired)return X.alert("Kartu telah habis masa berlaku","Perhatian",{type:"warning",center:!0,roundButton:!0,confirmButtonText:"OK",confirmButtonClass:"bg-red"}),e.is_member=0,!1;if(!A.expired&&A.expired_in<=5&&X.alert(`Kartu akan habis masa berlaku dalam ${A.expired_in} hari`,"Perhatian",{type:"warning",center:!0,roundButton:!0,confirmButtonText:"OK",confirmButtonClass:"bg-red"}),c.value.disable_plat_nomor){document.querySelector("#submit-btn").focus();const L=f.member.vehicles[0];e.jenis_kendaraan=L.jenis_kendaraan,e.plat_nomor=L.plat_nomor;const _=d.value.gate_outs.find(E=>E.jenis_kendaraan.includes(e.jenis_kendaraan));if(!_){y({message:"Tidak ada gate keluar untuk jenis kendaraan terkait",type:"error"});return}e.gate_out_id=_.id,c.value.member_auto_open&&(e.id&&de(),le(!1))}else A.vehicles.find(_=>_.plat_nomor==e.plat_nomor)?b.value.length>1&&document.querySelector("#jenis-kendaraan").focus():(X.alert("Plat nomor tidak cocok dengan kartu. Nomor plat yang terdaftar adalah "+A.vehicles.map(_=>_.plat_nomor).join(", "),"Perhatian",{type:"warning",center:!0,roundButton:!0,confirmButtonText:"OK",confirmButtonClass:"bg-red"}),document.querySelector("#plat-nomor").focus())}b.value.length==1&&(e.jenis_kendaraan=b.value[0].nama,Y())}catch(f){((m=f.response)==null?void 0:m.status)==404&&y({message:f.response._data.message,type:"error",center:!0,showClose:!0,duration:3e3}),document.querySelector("#nomor-tiket").focus()}},ie=()=>{var a;ye(),e.tarif="",e.denda="",e.gate_in_id=null,e.gate_out_id=null,e.jenis_kendaraan=null,e.plat_nomor=c.value.plat_nomor_default,e.nomor_barcode="",e.time_out="",e.time_in=void 0,e.duration="",w.value=[],(a=u==null?void 0:u.proxy)==null||a.$forceUpdate(),c.value.disable_plat_nomor?(console.log("ke nomor tiket"),document.querySelector("#nomor-tiket").focus()):(console.log("ke plat nomor"),document.querySelector("#plat-nomor").focus())},se=a=>{var t;if(console.log(e),e.nomor_barcode.toLowerCase()=="xxxxx"&&!e.time_in){document.querySelector("#time-in").focus();return}else document.querySelector("#submit-btn").blur();if(T.value.length==1&&(e.gate_in_id=T.value[0].id),!e.gate_in_id){y({message:"MOHON ISI GATE IN",type:"error",showClose:!0});return}if(!(!e.nomor_barcode||!e.gate_out_id||!e.jenis_kendaraan||!e.time_out)){if(((t=e.time_in)==null?void 0:t.length)<16){y({message:"FORMAT TIME IN SALAH",type:"error",showClose:!0});return}le(a)}},le=async a=>{e.ticket=a;const t=e.id?`/api/parkingTransaction/${e.id}`:"/api/parkingTransaction";try{const r=await C(t,{method:e.id?"put":"post",body:e});y({message:r.message,type:"success"});const m=e.gate_out_id;ue(m)}catch(r){y({message:r.response._data.message,type:"error",showClose:!0})}},ge=()=>{k.value=new WebSocket(`ws://${d.value.ip_address}:5678/`),k.value.onerror=a=>{y({message:"KONEKSI KE POS GAGAL",type:"error"})},k.value.onopen=a=>{console.log("POS TEKONEKSI")},k.value.onmessage=a=>{let t=JSON.parse(a.data);console.error(t)}},ue=a=>{const t=d.value.gate_outs.find(r=>r.id==a);k.value.send(["open",t.device,t.baudrate,t.open_command,t.close_command].join(";")),setTimeout(ie,1e3)},W=a=>{const t=d.value.gate_outs.find(r=>r.id==e.gate_out_id);t&&(!t.running_text_device||!t.running_text_baudrate||k.value.send(["rt",t.running_text_device,t.running_text_baudrate,a].join(";")))},ye=()=>{const a=d.value.gate_outs.find(t=>t.id==e.gate_out_id);a&&(!a.running_text_device||!a.running_text_baudrate||k.value.send(["rrt",a.running_text_device,a.running_text_baudrate].join(";")))},ne=async()=>{try{const a=await C("/api/parkingTransaction/printLastTransaction",{method:"post",body:{pos_id:e.pos_id}});y({message:a.message,type:"success",showClose:!0})}catch(a){y({message:a.response._data.message,type:"error",showClose:!0})}},oe=async()=>{let a={pos_id:e.pos_id,date:x().format("YYYY-MM-DD")};try{await C("/api/parkingTransaction/printReport",{method:"post",body:a}),y({message:"SILAKAN AMBIL STRUK",type:"success",showClose:!0})}catch(t){y({message:t.response._data.message,type:"error",showClose:!0})}},be=async()=>{await K.getPos(),d.value&&(e.pos_id=d.value.id,d.value.gate_outs.length==1&&(e.gate_out_id=d.value.gate_outs[0].id),e.plat_nomor=c.value.plat_nomor_default,c.value.disable_plat_nomor?document.querySelector("#nomor-tiket").focus():document.querySelector("#plat-nomor").focus(),ge())},de=async()=>{var a;try{const t=await C(`/api/parkingTransaction/takeSnapshot/${e.id}`,{method:"post",body:{gate_out_id:e.gate_out_id}});w.value=t,(a=u==null?void 0:u.proxy)==null||a.$forceUpdate()}catch(t){y({message:t.response._data.message,type:"error",showClose:!0})}};return pe(async()=>{await be(),d.value&&(document.getElementById("gate-out-app").addEventListener("keydown",a=>{var t;a.key=="-"&&(a.preventDefault(),ie(),(t=u==null?void 0:u.proxy)==null||t.$forceUpdate()),a.key=="+"&&(a.preventDefault(),e.nomor_barcode="",e.time_out="",e.jenis_kendaraan="",e.tarif="",document.querySelector("#nomor-tiket").focus()),a.key=="*"&&(a.preventDefault(),e.jenis_kendaraan="",e.tarif="",document.querySelector("#jenis-kendaraan").focus()),a.key=="/"&&(a.preventDefault(),e.time_in="",document.querySelector("#time-in").focus()),a.key=="F10"&&(a.preventDefault(),oe()),a.key=="F11"&&(a.preventDefault(),j.value=!0),a.key=="F12"&&(a.preventDefault(),ne())}),H.value=Be(K.getJenisKendaraanList,6e4))}),Oe(()=>{k.value&&k.value.close(),clearInterval(H.value)}),(a,t)=>{const r=ve,m=ke,f=Ue,I=De("mask");return n(d)?(p(),M("div",Ye,[l("div",$e,[l("h1",Re,V(n(d).nama),1),n(c).disable_plat_nomor?F("",!0):(p(),q(m,{key:0,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Ve]),_:1}),s(r,{span:14},{default:i(()=>[N(l("input",{id:"plat-nomor",autocomplete:"off",onKeyup:h(z,["enter"]),type:"text",placeholder:"NO. PLAT","onUpdate:modelValue":t[0]||(t[0]=o=>n(e).plat_nomor=o),class:"my-input"},null,544),[[Z,n(e).plat_nomor]])]),_:1})]),_:1})),s(m,{gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Fe]),_:1}),s(r,{span:14},{default:i(()=>[N(l("input",{id:"nomor-tiket",autocomplete:"off",onKeyup:h(v,["enter"]),onKeydown:h(v,["tab"]),type:"text",placeholder:"NO. TIKET/KARTU","onUpdate:modelValue":t[1]||(t[1]=o=>n(e).nomor_barcode=o),class:"my-input"},null,544),[[Z,n(e).nomor_barcode]])]),_:1})]),_:1}),n(b).length>1?(p(),q(m,{key:1,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[He]),_:1}),s(r,{span:14},{default:i(()=>[N(l("select",{onChange:Y,"onUpdate:modelValue":t[2]||(t[2]=o=>n(e).jenis_kendaraan=o),id:"jenis-kendaraan",class:"my-input",placeholder:"JENIS KENDARAAN"},[(p(!0),M(ee,null,te(n(b),o=>(p(),M("option",{value:o.nama,key:o.id},V(o.shortcut_key)+" - "+V(o.nama),9,Ge))),128))],544),[[_e,n(e).jenis_kendaraan]])]),_:1})]),_:1})):F("",!0),N(s(m,{gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Je]),_:1}),s(r,{span:14},{default:i(()=>[N(l("input",{onKeyup:h(G,["enter"]),onChange:Y,id:"time-in","onUpdate:modelValue":t[3]||(t[3]=o=>n(e).time_in=o),class:"my-input"},null,544),[[I,"####-##-## ##:##"],[Z,n(e).time_in]])]),_:1})]),_:1},512),[[ce,n(e).nomor_barcode=="xxxxx"]]),n(T).length>1?N((p(),q(m,{key:2,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[ze]),_:1}),s(r,{span:14},{default:i(()=>[N(l("select",{onChange:ae,"onUpdate:modelValue":t[4]||(t[4]=o=>n(e).gate_in_id=o),id:"gate-in",class:"my-input"},[(p(!0),M(ee,null,te(n(T),o=>(p(),M("option",{value:o.id,key:o.id},V(o.shortcut_key)+" - "+V(o.nama),9,We))),128))],544),[[_e,n(e).gate_in_id]])]),_:1})]),_:1},512)),[[ce,n(e).nomor_barcode=="xxxxx"]]):F("",!0),s(m,{gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Qe]),_:1}),s(r,{span:14},{default:i(()=>[N(l("input",{disabled:"","onUpdate:modelValue":t[5]||(t[5]=o=>n(e).tarif=o),class:"my-input bg-red-700 text-white"},null,512),[[Z,n(e).tarif]])]),_:1})]),_:1}),n(e).nomor_barcode=="xxxxx"?(p(),q(m,{key:3,gutter:10,style:{"margin-bottom":"10px"}},{default:i(()=>[s(r,{span:10},{default:i(()=>[Ze]),_:1}),s(r,{span:14},{default:i(()=>[l("input",{disabled:"",value:Number(n(e).tarif)+Number(n(e).denda),class:"my-input bg-red-700 text-white"},null,8,Xe)]),_:1})]),_:1})):F("",!0),l("button",{id:"submit-btn",onKeyup:[h(J,["right"]),h(J,["down"])],onKeydown:t[6]||(t[6]=h(o=>se(!1),["enter"])),class:"my-big-btn",onClick:t[7]||(t[7]=o=>se(!1))}," BUKA GATE ",32),l("button",{id:"submit-btn1",onKeyup:[h(R,["left"]),h(R,["up"])],onKeydown:h(ne,["enter"]),class:"my-big-btn",onClick:ne}," [F12] PRINT STRUK TRANSAKSI TERAKHIR ",32),s(m,{gutter:10},{default:i(()=>[s(r,{span:12},{default:i(()=>[l("button",{onKeydown:h(oe,["enter"]),class:"my-big-btn",onClick:oe}," [F10] PRINT LAPORAN ",32)]),_:1}),s(r,{span:12},{default:i(()=>[l("button",{class:"my-big-btn",onKeydown:t[8]||(t[8]=h(o=>j.value=!0,["enter"])),onClick:t[9]||(t[9]=o=>j.value=!0)}," [F11] BUKA GATE MANUAL ",32)]),_:1})]),_:1})]),l("div",{class:Ce({"ml-5":!0,flex:n(c).orientasi_kamera=="POTRAIT"}),style:{width:"100%"}},[(p(!0),M(ee,null,te(n(w),o=>(p(),M("div",{class:"mb-1",style:{width:"100%"},key:o.id},[l("img",{src:o.url,style:{width:"700px"}},null,8,et)]))),128))],2),s(f,{show:n(j),onClose:t[10]||(t[10]=o=>j.value=!1),gateOutList:n(d).gate_outs,onOpenGate:t[11]||(t[11]=o=>ue(o))},null,8,["show","gateOutList"])])):(p(),M("div",tt,nt))}}},pt=Ee(ot,[["__scopeId","data-v-68ff1853"]]);export{pt as default};
